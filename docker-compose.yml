services:
  # ============================================
  # INFRAESTRUCTURA KAFKA
  # ============================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    hostname: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - emergent-etl-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    hostname: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"     # Listener interno (para otros contenedores)
      - "29092:29092"   # Listener externo (para host Windows)
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168  # 7 días
      KAFKA_LOG_SEGMENT_BYTES: 1073741824  # 1GB
      KAFKA_NUM_PARTITIONS: 3
    networks:
      - emergent-etl-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    container_name: schema-registry
    hostname: schema-registry
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka:9092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
    networks:
      - emergent-etl-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/subjects"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # BASES DE DATOS
  # ============================================
  mysql:
    image: mysql:8.0
    container_name: mysql
    hostname: mysql
    ports:
      - "3307:3306"  # Puerto externo 3307 para evitar conflicto con MySQL local
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-emergent_etl}
      MYSQL_USER: ${MYSQL_USER:-etl_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-etl_password}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/mysql/init:/docker-entrypoint-initdb.d
    networks:
      - emergent-etl-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: --default-authentication-plugin=mysql_native_password

  mongo:
    image: mongo:7.0
    container_name: mongo
    hostname: mongo
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-adminpassword}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-emergent_etl}
    volumes:
      - mongo_data:/data/db
      - ./database/mongodb/init:/docker-entrypoint-initdb.d
    networks:
      - emergent-etl-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # SERVICIOS DE PROCESAMIENTO
  # ============================================
  # Nota: Estos servicios se agregarán en fases posteriores
  # Por ahora están comentados hasta que se implementen
  
  # simulator-csv:
  #   build: ./simulator
  #   container_name: simulator-csv
  #   depends_on:
  #     kafka:
  #       condition: service_healthy
  #   environment:
  #     KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  #     CSV_DIRECTORY: /app/data/csv
  #   volumes:
  #     - ./data/csv:/app/data/csv:ro
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # listener-router:
  #   build: ./listener-router
  #   container_name: listener-router
  #   depends_on:
  #     kafka:
  #       condition: service_healthy
  #     spark-master:
  #       condition: service_started
  #   environment:
  #     KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  #     SPARK_HOST: spark-master
  #     SPARK_PORT: ${SPARK_PORT:-7077}
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # spark-master:
  #   build: ./spark-etl
  #   container_name: spark-master
  #   ports:
  #     - "8080:8080"  # Spark UI
  #     - "7077:7077"  # Spark Master
  #   environment:
  #     SPARK_MODE: master
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # spark-worker-1:
  #   build: ./spark-etl
  #   container_name: spark-worker-1
  #   depends_on:
  #     - spark-master
  #   environment:
  #     SPARK_MODE: worker
  #     SPARK_MASTER_URL: spark://spark-master:7077
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # spark-worker-2:
  #   build: ./spark-etl
  #   container_name: spark-worker-2
  #   depends_on:
  #     - spark-master
  #   environment:
  #     SPARK_MODE: worker
  #     SPARK_MASTER_URL: spark://spark-master:7077
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # api-gateway:
  #   build: ./api-gateway
  #   container_name: api-gateway
  #   depends_on:
  #     mysql:
  #       condition: service_healthy
  #     mongo:
  #       condition: service_healthy
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     MYSQL_HOST: mysql
  #     MYSQL_DATABASE: ${MYSQL_DATABASE:-emergent_etl}
  #     MYSQL_USER: ${MYSQL_USER:-etl_user}
  #     MYSQL_PASSWORD: ${MYSQL_PASSWORD:-etl_password}
  #     MONGO_HOST: mongo
  #     MONGO_DATABASE: ${MONGO_DATABASE:-emergent_etl}
  #     MONGO_USER: ${MONGO_ROOT_USERNAME:-admin}
  #     MONGO_PASSWORD: ${MONGO_ROOT_PASSWORD:-adminpassword}
  #     JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # frontend:
  #   build: ./frontend
  #   container_name: frontend
  #   depends_on:
  #     - api-gateway
  #   ports:
  #     - "3001:3000"
  #   environment:
  #     REACT_APP_API_URL: http://localhost:3000/api
  #     REACT_APP_WS_URL: ws://localhost:3000
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # ============================================
  # MONITOREO
  # ============================================
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: prometheus
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
  #     - prometheus_data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: grafana
  #   depends_on:
  #     - prometheus
  #   ports:
  #     - "3002:3000"
  #   environment:
  #     GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
  #   volumes:
  #     - grafana_data:/var/lib/grafana
  #     - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
  #   networks:
  #     - emergent-etl-network
  #   restart: unless-stopped

# ============================================
# VOLÚMENES
# ============================================
volumes:
  mysql_data:
    driver: local
  mongo_data:
    driver: local
  # prometheus_data:
  #   driver: local
  # grafana_data:
  #   driver: local

# ============================================
# REDES
# ============================================
networks:
  emergent-etl-network:
    driver: bridge

